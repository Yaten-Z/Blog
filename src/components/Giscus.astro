---
/**
 * Giscus 评论组件
 * 
 * 使用前需要在 .env 或 astro.config.mjs 中配置以下环境变量：
 * - GISCUS_REPO
 * - GISCUS_REPO_ID
 * - GISCUS_CATEGORY
 * - GISCUS_CATEGORY_ID
 */

interface Props {
  id?: string;
}

const { id = "giscus-comments" } = Astro.props;

---

<div {id} class="giscus-wrapper">
  <script
    src="https://giscus.app/client.js"
    data-repo="Yaten-Z/blog-giscus"
    data-repo-id="R_kgDOOzg2eg"
    data-category="Announcements"
    data-category-id="DIC_kwDOOzg2es4Cq1Mo"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="noborder_light"
    data-lang="zh-CN"
    data-loading="lazy"
    crossorigin="anonymous"
    async
  >
  </script>
</div>

<style>
  .giscus-wrapper {
    @apply my-12;
  }
</style>

<script>
  function updateGiscusTheme(isDark: boolean) {
    const theme = isDark ? "noborder_dark" : "noborder_light";
    const iframe = document.querySelector("iframe.giscus-frame") as HTMLIFrameElement;
    if (iframe) {
      iframe.contentWindow?.postMessage(
        { giscus: { setConfig: { theme } } },
        "https://giscus.app"
      );
    }
  }

  // 初始化主题
  function initGiscusTheme() {
    const isDark = document.documentElement.classList.contains("dark");
    // 给iframe加载时间
    setTimeout(() => updateGiscusTheme(isDark), 1500);
  }

  // 监听主题变化
    function setupGiscusThemeListener() {
        const observer = new MutationObserver(() => {
        const isDark = document.documentElement.classList.contains("dark");
        updateGiscusTheme(isDark);
        });
    
        observer.observe(document.documentElement, { attributes: true, attributeFilter: ["class"] });
    }

  // 页面加载完成时初始化
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
      initGiscusTheme();
      setupGiscusThemeListener();
    });
  } else {
    initGiscusTheme();
    setupGiscusThemeListener();
  }

  // 监听 Astro 页面转换
  document.addEventListener("astro:after-swap", () => {
    initGiscusTheme();
  });
</script>